#!/usr/bin/make -f

DEB_HOST_ARCH_CPU	?= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

# To distinguish variables that are truly local to this file (rather
# than for use by cdbs), we adopt the convention of starting local
# variables' names with l_.

l_PWD := $(shell pwd)
l_STAMPS := debian/l_stamps
l_RUN_CHECK := 1
l_CFLAGS := -g -Wall
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	l_CFLAGS += -O0
else
	l_CFLAGS += -O2
endif

# Make sure structures are padded at no larger than byte boundaries.
ifeq ($(shell dpkg --print-architecture),arm)
l_CFLAGS += -mstructure-size-boundary=8
endif

# common configure cruft
l_CONFIGURE = CC="gcc" CXX="g++" CPPFLAGS="" LDFLAGS="" \
	./configure \
	--build=$(DEB_BUILD_GNU_TYPE) --prefix=/usr \
	--includedir="\$${prefix}/include" \
	--mandir="\$${prefix}/share/man" --infodir="\$${prefix}/share/info" \
	--sysconfdir=/etc --localstatedir=/var \
	--disable-maintainer-mode --disable-dependency-tracking
# specific to this package
l_CONFIGURE += --disable-samples --enable-static --enable-weak-threads

ifneq (, $(filter $(DEB_HOST_ARCH_CPU), amd64 ppc64 kfreebsd-amd64))
build32 := build32
endif

# Variables used by cdbs

VERSION := $(shell dpkg-parsechangelog | \
             awk '/Version:/ {print $$2}' | cut -d- -f 1)

DEB_TAR_SRCDIR = icu/source
DEB_COMPRESS_EXCLUDE = html examples
DEB_INSTALL_EXAMPLES_libicu-dev = \
	build-tree/$(DEB_TAR_SRCDIR)/samples/*

# Overridden for 32-bit packages on 64-bit platforms
DEB_DH_INSTALL_SOURCEDIR=debian/tmp

DEB_DBG_PACKAGE_libicu38 = libicu38-dbg

# Include cdbs rules files.
include /usr/share/cdbs/1/rules/tarball.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
include /usr/share/cdbs/1/rules/debhelper.mk

cleanbuilddir::
	$(RM) -r $(l_STAMPS)

# As 0.4.21, cdbs creates but doesn't remove debian/compat.  It
# creates it conditionally, so this doesn't have a trivial fix.
clean::
	$(RM) debian/compat *.cdbs-config_list
	$(RM) -rf debian/tmp32
	$(RM) debian/stamp-configure debian/stamp-configure32

post-patches::
	chmod a+x $(DEB_SRCDIR)/configure
ifneq (, $(build32))
	cp -a $(DEB_SRCDIR) $(DEB_SRCDIR)-build32
endif

configure/libicu38 configure/libicu-dev:: debian/stamp-configure
debian/stamp-configure:
	cd $(DEB_SRCDIR) && \
		CFLAGS="$(l_CFLAGS)" CXXFLAGS="$(l_CFLAGS)" \
		$(l_CONFIGURE)
	touch debian/stamp-configure

configure/lib32icu38 configure/lib32icu-dev:: debian/stamp-configure32
debian/stamp-configure32:
	cd $(DEB_SRCDIR)-build32 && \
		CFLAGS="$(l_CFLAGS) -m32" CXXFLAGS="$(l_CFLAGS) -m32" \
		$(l_CONFIGURE) --libdir=/usr/lib32
	touch debian/stamp-configure32

build/libicu38 build/libicu-dev::
	$(MAKE) -C $(DEB_SRCDIR)

build/lib32icu38 build/lib32icu-dev::
	$(MAKE) -C $(DEB_SRCDIR)-build32

install/libicu38 install/libicu-dev::
	$(MAKE) -C $(DEB_SRCDIR) install DESTDIR=$(CURDIR)/debian/tmp

binary-install/lib32icu38 binary-install/lib32icu-dev:: DEB_DH_INSTALL_SOURCEDIR=debian/tmp32
install/lib32icu38 install/lib32icu-dev::
	$(MAKE) -C $(DEB_SRCDIR)-build32 install DESTDIR=$(CURDIR)/debian/tmp32

install/icu-doc:: install/libicu38 install/libicu-dev
	$(MAKE) -C $(DEB_SRCDIR) install-doc DESTDIR=$(CURDIR)/debian/tmp

ifeq ($(DEB_HOST_ARCH),amd64)
# On amd64 only, it appears that we need to put these in a different
# location.
binary-install/lib32icu38 binary-install/lib32icu-dev::
	mkdir -p debian/$(cdbs_curpkg)/emul/ia32-linux/usr
	mv debian/$(cdbs_curpkg)/usr/lib32 debian/$(cdbs_curpkg)/emul/ia32-linux/usr/lib
endif

# As per upstream, icuswap is deprecated and should not be
# distributed.
binary-post-install/libicu-dev::
	rm debian/$(cdbs_curpkg)/usr/sbin/icuswap

# Install lintian override files
binary-post-install/%::
	if [ -f debian/$*.lintian ]; then \
	    mkdir -p debian/$*/usr/share/lintian/overrides && \
	    cp -p debian/$*.lintian debian/$*/usr/share/lintian/overrides/$*; \
	fi

binary-predeb/%::
	perl debian/fix_substvars.pl debian/$*.substvars 'lib(32)?icu.*'
